@page "/employeeProject"
@page "/employeeProject/{Id:int}"

@using AVATI.Data
@using DocumentFormat.OpenXml.Drawing
@using DocumentFormat.OpenXml.InkML

@inject IProjektService _projektService
@inject JsonImport _jsonImport

@inject IProjectActivityService _projectActivityService
@inject NavigationManager _navManager
@inject IEmployeeService _employeeService

<h3>Projektübersicht</h3>

<EditForm Model="projActivity" >
<table id="table" data-show-refresh="true" class="table align-middle mb-5">
    <thead>
    <div class="form-group">
        <input class="form-control" type="text" placeholder="Suche Projekt..."
               @bind="Filter"
               @bind:event="oninput">
    </div>
    <tr>
        <th scope="col">Projekttitel</th>
        <th scope="col">Projektbeschreibung</th>
        <th scope="col">Projekttätigkeit</th>
    </tr>
    </thead>
    <tbody>
    @if (_projectActivityService.GetProjectActivitiesEmployee(Id).Any())
    {
        @foreach (var activity in _projectActivityService.GetProjectActivitiesEmployee(Id))
        {
            
                Project proj = _projektService.GetProject(activity.ProjectID);
                <tr>
                    <td>@proj.Projecttitel</td>
                    <td>@proj.Projectdescription</td>
                    <td>@activity.Description</td>
                    <td>
                        <button type="button" @onclick="(() => { UpdateActivity(projActivity.Description, activity.Description, proj.ProjectID); })" class="btn btn-secondary oi oi-pencil"></button>
                        <button type="button" @onclick="(() => { deleteProjectActivity(Id, proj.ProjectID, activity.Description); })" class="btn btn-danger oi oi-trash">Löschen</button>
                    </td>
                </tr>
            
        }
    }
    else
    {
        <tr>
            <td></td>
            <td></td>
        </tr>
    }
    @if (_projektService.GetAllProjects().Any())
    {
        @foreach (var projects in _projektService.GetAllProjects())
        {
            @if (!IsVisible(projects.Projecttitel))
                continue;
            projactList = _projectActivityService.GetEmployeeProjectActivities(Id, projects.ProjectID);

            if (projactList.Find(x => x.EmployeeID == Id) == null)
            {
                <tr>
                    <td>@projects.Projecttitel</td>
                    <td>@projects.Projectdescription</td>
                    <td>

                        <select class="rounded form-control" type="text"  @bind="@projActivity.Description" placeholder="">
                            @foreach (var projACT in _projectActivityService.GetAllProjectActivities())
                            {
                                <option>@projACT.Description</option>
                            }
                        </select>

                    </td>
                    <td>
                        <button type="button" @onclick="(() => { setProjectActivity(Id, projects.ProjectID, projActivity.Description); })" class="btn btn-success oi oi-plus"></button>

                    </td>
                </tr>
            }
        }
    }
    else
    {
        <tr>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    }
    </tbody>
</table>
</EditForm>

@code
{
    [Parameter]
    public int Id { get; set; }

    public Employee Emp { get; set; }

    public ProjectActivity projActivity { get; set; }
    public Project project { get; set; }
    public List<ProjectActivity> projactList = new List<ProjectActivity>();


    public string Input { get; set; }
    public bool Clicked { get; set; } = false;

    private string Filter { get; set; }

    protected override void OnInitialized()
    {
        projActivity = new ProjectActivity();
        Emp = new Employee();
    }

    public bool IsVisible(string titel)
    {
        if (string.IsNullOrEmpty(Filter))
        {
            return true;
        }
        return titel.Contains(Filter, StringComparison.OrdinalIgnoreCase);
    }

    public void setProjectActivity(int empId, int projId, string description)
    {
        _projectActivityService.AddActivity(description);
        _projectActivityService.SetProjectActivity(empId, projId, description);
        _navManager.NavigateTo("/employeeProject/" + Emp.EmployeeID, forceLoad: true);
    }
    
    public void UpdateActivity(string newDescription, string oldDescription, int projID)
    {
        _projectActivityService.ChangeProjectActivity(Id, projID, oldDescription,  newDescription);
        _navManager.NavigateTo("/employeeProject/" + Emp.EmployeeID, forceLoad: true);
    }

    public void deleteProjectActivity(int empId, int projId, string desc)
    {
        _projectActivityService.DeleteProjectActivityEmployee(empId, projId, desc);
        _navManager.NavigateTo("/employeeProject/" + Emp.EmployeeID, forceLoad: true);
    }


}