@using AVATI.Data
@using DocumentFormat.OpenXml.Drawing

@inject IHardskillService _hardskillService
@inject NavigationManager _navigationManager

<div class="modal @(_show ? "fade show" : "" )" id="myModal" style=" display: @(_show ? "block" : "none");">
               <div class="modal-dialog">
                 <div class="modal-content">
                   <div class="modal-header">
                     <h4 class="modal-title">Erstelle ein Hardskill</h4>
                     <button type="button" class="close" data-dismiss="modal" @onclick="Showing">&times;</button>
                   </div>
                   <EditForm Model="@_hardskill">
                     @if (_showExistError){
                       <div class="errormessage">
                         <a><b>Es existiert bereits ein Hardskill oder eine Hardskillkategorie mit derselben Bezeichnung</b></a>
                       </div>
                     } else if (_showEmptyError){
                       <div class="errormessage">
                         <a><b>Die Bezeichnung ist erforderlich</b></a>
                        </div>
                     } else if (_showTooLongError)
                     {
                       <div class="errormessage">
                         <a><b>Die Bezeichnung ist zu lang (max. 150 Zeichen)</b></a>
                       </div>
                     }
                     <div class="modal-body">
                       <label class="form-label">Bezeichnung:</label>
                       <InputText class="form-control" @bind-Value="@_hardskill.Description"/>
                       <label class="form-label">Oberkategorie:</label>
                       <div>
                         @if (UpperCat != null && UpperCat.Any())
                         {
                           foreach (var uppercat in UpperCat)
                           {
                             <a style="margin-left: 5px; margin-top: 5px; color: white !important;" class="btn btn-primary" type="button" @onclick="() => UpperCatList(uppercat)">
                               <a class="showRemove">@uppercat</a> <a class="remove"><span class="oi oi-x"></span></a>
                             </a>
                           }
                         }
                         else
                         {
                           <tr style="color: #818181 !important;">Keine Oberkategorie</tr>
                         }
                       </div>
                       <hr/>                      
                       <div class="list-group border-dark overflow-auto mr-3 col-9" style="height: 100px">
                         @if (_allCategorys != null)
                         {
                           foreach (var cat in _allCategorys)
                           {
                             <button style="margin-bottom: 3px;" type="button" class="@(IsInList(cat) ? "btn btn-primary btn-sm" : "btn btn-secondary btn-sm")" @onclick="() => UpperCatList(cat)">
                               <a><a class="@(IsInList(cat) ? "showRemove" : "")">@cat</a> <a class="remove"><span class="oi oi-x"></span></a></a>
                             </button>
                           }
                         }
                       </div>
                     </div>
                     <div class="modal-footer">
                       <button type="button" class="btn btn-danger" data-dismiss="modal" @onclick="Showing">Abbrechen</button>
                       <button type="button" class="btn btn-success" @onclick="Create">Speichern</button>
                     </div>
                   </EditForm>
                 </div>
               </div>
          </div>
@if (_show)
{
  <div class="modal-backdrop fade show"></div>
}

@code {
  [Parameter] public BasicDataAbstract Abstract { get; set; }
  private bool _show = false;
  
  string Description { get; set; }

  private List<string> UpperCat { get; set; } = new();

  private Hardskill _hardskill = new();

  private List<string> _allCategorys;
  
  private bool _showEmptyError;

  private bool _showExistError;

  private bool _showTooLongError;

  protected override async Task OnInitializedAsync()
  {
    _allCategorys = await _hardskillService.GetAllDesCategorys();
  }
  
  protected override void OnParametersSet()
  {
    _showEmptyError = false;
    _showExistError = false;
    _showTooLongError = false;
    Description = "";
    UpperCat.Clear();

  }

  private async Task Create()
  {
    if (!_hardskillService.CheckEmptyHardskill(_hardskill.Description))
    {
      _showEmptyError = true;
      _showExistError = false;
      _showTooLongError = false;
      StateHasChanged();
      return;
    }
    _showEmptyError = false;

    if (!await _hardskillService.CheckExistHardskill(_hardskill.Description))
    {
      _showExistError = true;
      _showTooLongError = false;
      StateHasChanged();
      return;
    }
    _showExistError = false;

    if (!_hardskillService.CheckLengthHardskill(_hardskill.Description))
    {
      _showTooLongError = true;
      StateHasChanged();
      return;
    }
    _showTooLongError = false;
    
    var hardskill = new Hardskill
    {
      Description = _hardskill.Description,
      Uppercat = new List<string>(UpperCat),
      Subcat = null
    };

    await _hardskillService.CreateHardskill(hardskill);
    Showing();
    UpperCat.Clear();
    _hardskill.Description = "";
    await Abstract.UpdateCategorys();
    await Abstract.UpdateHardskills();
  }

  private void UpperCatList(string description)
  {
    if (UpperCat.Contains(description))
      UpperCat.Remove(description);
    else
      UpperCat.Add(description);
    StateHasChanged();
  }

  private bool IsInList(string description)
  {
    return UpperCat.Contains(description);
  }

  public void Showing()
  {
    _show = !_show;
    StateHasChanged();
  }
    
}